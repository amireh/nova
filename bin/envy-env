#!/usr/bin/env bash

for file in "$ENVY_DIR"/*; do
  var_file="$(basename "$file")"
  var_name="$(echo "$var_file" | sed 's/^[0-9]*-//')"

  if [[ $var_file == '*' ]]; then
    echo "$0: no files found in $ENVY_DIR" 1>&2
    exit 1
  fi

  export "${var_name?}" || exit $?

  if [[ -f $ENVY_CACHE_DIR/$var_name ]]; then
    read -r "${var_name?}" < "$ENVY_CACHE_DIR/$var_name"
  else
    read -r "${var_name?}" < <(bash "$file") || {
      echo "$0: unable to export $var_name" 1>&2
      exit 1
    }

    echo "${!var_name}" > "$ENVY_CACHE_DIR/$var_name"
  fi

  echo "${var_name}=${!var_name}"
done
